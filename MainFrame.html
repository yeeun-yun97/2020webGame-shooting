<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #myCanvas {
            border: 1px solid black;
        }
    </style>

    <script src= "https://code.jquery.com/jquery-3.5.1.js"></script>

    <script>

        ////////////////////////////// attribute ///////////////////////////
        // canvas
        var context;
        var width = 1000;
        var height = 700;
        var image = new Image();
        image.src = "lawn.png";

        var gameOver = new Image();
        gameOver.src="images/GameOver.png";
        var victory = new Image();
        victory.src="images/victory.png";
        var boom = new Image(110,101);
        boom.src="images/boom.png";


        var timer;
        var timer2;
        // tank        
        var myPlane;
        // enemy
        var enemies = [];
        var maxEnemy = 7;
        var enemyAlive = 0;
        // bullet
        var playerMissile = [];
        var enemyMissile = [];
        var playerMissileIndex = 0;
        var enemyMissileIndex = 0;

        var gamePlaying= false;





        ///////////////////////////////////////


        function random (min, max){
            return Math.floor(Math.random() * (max - min) + min);
        }
        ////////////////////////////// function ///////////////////////////
        function init() {
            if(!gamePlaying){

                gamePlaying=true;
                enemies = [];
                enemyAlive = 0;
                playerMissile = [];
                enemyMissile = [];
                playerMissileIndex = 0;
                enemyMissileIndex = 0;
                context = document.getElementById('myCanvas').getContext('2d'); 
                myPlane = new Player();
                createEnemy();
                draw();

                //interval 계속 실행
                timer = setInterval(draw, 15);
                timer2 = setInterval(enemyAttack, 500);
                timer3 = setInterval(attack, 200);
            }
        }
        
        function createEnemy() {
            for(var e =0; e<maxEnemy; e++) {
                enemies.push(new Enemy());
                enemyAlive++;
            }
        }

        //적이 끝없이 나오는건 너무 힘든게 아닌가..하는 생각이 들어서
        // 일단 지워놨습니다!!
        //오래 버티기가 목적인 게임이면 이렇게 해도 나쁘지 않을 것 같고,
        //스테이지로 나누거나, 빨리 깨는 게 목적인 게임이면 끝이 있어야 하니까 
        //어떤 게임으로 할 지 의견을 조율해야 할 것 같아요!!
        function enemyAttack() {
            // createEnemy();
            for (var i = 0; i < enemyAlive; i++){
                var temp = random(0,3);
                if (temp > 1 && enemies[i] != null) {                    
                    enemies[i].fire();                    
                }
            }
        }

        //비행기와 적과 미사일들을 그린다. interval 15
        function draw() {
            context.clearRect(0, 0, width, height);  
            // drawBackground();
            drawPlane();
            drawEnemy();
            drawMissile();            
        }
        
        //draw에서 호출: 비행기를 움직이게 하고, 그린다. 
        function drawPlane() {
            myPlane.move();            
            myPlane.draw();
        }
        //draw에서 호출: 적을 움직이게 하고, 그린다. 
        function drawEnemy() {
            for (var i in enemies) {
                enemies[i].move();
                enemies[i].draw();
            }
        }
        //draw에서 호출: 미사일을 그린다. 
        function drawMissile() { 
            for (var i in enemyMissile) { 
                if (enemyMissile[i] != null) {
                    enemyMissile[i].enemyShot();
                    enemyMissile[i].onHit(myPlane);
                    enemyMissile[i].draw();
                }
            }  
            for (var i in playerMissile) {
                playerMissile[i].playerShot();
                for (var j in enemies) {
                    playerMissile[i].onHit(enemies[j]);
                }
                playerMissile[i].draw();                
            }       
        }

        //
        function attack() {
            myPlane.fire();
        }

        //배경을 그린다. 
        function drawBackground() {
            for (var i = 0; i < 1000; i+=100){
                for (var j = 0; j < 700; j +=70){
                    context.drawImage(image, i, j);        
                }
            }            
        }

        function gameSet(resultImage){
           clearInterval(timer);
           clearInterval(timer2);
           clearInterval(timer3); 
           gamePlaying=false;
           context.drawImage(resultImage,(width/2)-(resultImage.width/2),(height/2)-(resultImage.height/2));
       }

        ////////////////////////////keyListener//////////////////////////
        function keydownHandler(event) {

            if(!gamePlaying){
                init();
            }

            if (event.keyCode == 37) { // leftArrow <-
                myPlane.planeLeftPressed = true;
            } else if (event.keyCode == 39) { // rightArrow ->
                myPlane.planeRightPressed = true;
            } else if (event.keyCode == 32) { // spaceBar
                myPlane.missileLaunch = true;
            }
        };
        function keyupHandler(event) {
            if (event.keyCode == 37) { // leftArrow <-
                myPlane.planeLeftPressed = false;
            } else if (event.keyCode == 39) { // rightArrow ->
                myPlane.planeRightPressed = false;
            } else if (event.keyCode == 32) { // spaceBar
                myPlane.missileLaunch = false;
            }
        };
        document.addEventListener("keydown", keydownHandler, false);
        document.addEventListener("keyup", keyupHandler, false);
        ////////////////////////////// object ///////////////////////////
        function Player() {
            this.width = 70;
            this.height = 20;
            this.X = 500;
            this.Y = 680;
            this.planeVX = 5;
            this.planeLeftPressed = false;
            this.planeRightPressed = false;
            this.missileLaunch = false;
            this.color = "black";

            this.draw = function() {
                context.beginPath();
                context.rect(this.X, this.Y, this.width, this.height);
                context.fillStyle = this.color;
                context.fill();
            }
            this.move = function() {
                //영역밖으로 안나간다.
                if (this.planeLeftPressed && this.X > 0) {
                    this.X -= this.planeVX;
                }
                if (this.planeRightPressed && this.X+this.width < width) {
                    this.X += this.planeVX;
                }
            }
            this.fire = function() {
                if (this.missileLaunch) 
                    playerMissile[playerMissileIndex++] = new Missile(this.color, this.X+this.width/2, this.Y);
            }

            this.boom = function(){
             context.drawImage(boom,this.X+(this.width/2)-(boom.width)
               ,this.Y+(this.height/2)-(boom.height));
         }          
     }


     function Enemy() {
        this.X = random(0, 1000-70);
        this.Y = random(0, 300-20);
        this.width = 70;
        this.height = 20;
        this.enemyVX = random(1, 4);
        this.direction = false;
        this.color = "hsl("+ random(0, 360) +", 60%, 50%)";

        this.draw = function() {
            context.beginPath();
            context.rect(this.X, this.Y, this.width, this.height);
            context.fillStyle = this.color;
            context.fill();
        }
        this.move = function() {
                if (!this.direction) { // move to left
                    this.X -= this.enemyVX; 
                    if (this.X < 4) // switch direction
                        this.direction = true;
                } else { // move to right
                    this.X += this.enemyVX;
                    if (this.X > 1000-70) // switch direction
                        this.direction = false;
                }                
            }
            this.fire = function() {
                enemyMissile[enemyMissileIndex] = new Missile(this.color, this.X+this.width/2, this.Y);
                enemyMissile[enemyMissileIndex].setSpeed();
                enemyMissileIndex++;
            }

            this.boom = function(){
                context.drawImage(boom,this.X+(this.width/2)-(boom.width)
                   ,this.Y+(this.height/2)-(boom.height));
            }         
        }


        function Missile(color, X, Y) {
            this.X = X;
            this.Y = Y;
            this.width = 5;
            this.height = 10;
            this.missileVY = 4;
            this.color = color;
            
            this.draw = function() {
                context.beginPath();
                context.rect(this.X, this.Y, this.width, this.height);
                context.fillStyle = this.color;
                context.fill();

                //성능이슈를 위해 여기서 만약 미사일이 
                //캔버스에서 나갔을 때 배열에서 지워주는게 좋을 것 같다..

            }
            this.playerShot = function() {
                this.Y -= this.missileVY;
            }
            this.enemyShot = function() {
                this.Y += this.missileVY;
            }
            this.setSpeed = function() {
                this.missileVY = random(3, 7);
            }
            this.onHit = function(object) {
                if (this.X > object.X && this.X < object.X+object.width
                    && this.Y > object.Y && this.Y < object.Y+object.height) 
                {
                    object.boom();
                    if (object == myPlane) {
                       gameSet(gameOver);
                   } else {
                    const index =enemies.indexOf(object);
                    if(index>-1) enemies.splice(index,1);
                    enemyAlive--;
                    if(enemyAlive===0){
                       gameSet(victory);

                   }
               }
           }
       }                
   }

</script>
</head>
<body>

    <canvas id="myCanvas" width="1000px" height="700px"></canvas>
    
    <script>
        alert("??");
       var start = new Image();
       start.src="images/start.png";
       document.getElementById('myCanvas').getContext('2d').drawImage(start,0,0);
   </script>

   <!--     <button type="button" onclick="init();">시작</button> -->
</body>
</html>